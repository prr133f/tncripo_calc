name: CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk xvfb

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: Create virtual environment with Python 3.12
        run: uv venv --python 3.12

      - name: Install dependencies and pytest
        run: |
          source .venv/bin/activate
          uv pip install -e . pytest

      - name: Run tests in virtual display
        run: |
          source .venv/bin/activate
          xvfb-run -a pytest -q tests

  build-exe:
    runs-on: windows-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Create virtual environment with Python 3.12
        run: uv venv --python 3.12

      - name: Install dependencies and PyInstaller
        run: |
          . .venv/Scripts/activate
          uv pip install -e . pyinstaller

      - name: Build EXE (GUI app)
        run: |
          . .venv/Scripts/activate
          pyinstaller --onefile --windowed main.py

      - name: Upload EXE artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-windows-exe
          path: |
            tncripo_calc/dist/tncripo_calc.exe
            tncripo_calc/dist/main.exe
            dist/tncripo_calc.exe
            dist/main.exe
          retention-days: 7

  build-deb:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install system deps for .deb build
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential dpkg-dev python3-tk python3-pip unzip

      - name: Install PyInstaller
        run: |
          python3 -m pip install --upgrade pip setuptools wheel
          python3 -m pip install pyinstaller

      - name: Build linux standalone binary with PyInstaller
        run: |
          set -e
          # detect project dir: prefer tncripo_calc if exists, otherwise root
          if [ -d "tncripo_calc" ]; then SRC_DIR=tncripo_calc; else SRC_DIR=.; fi
          echo "Using SRC_DIR=${SRC_DIR}"
          # ensure project dependencies are installed so PyInstaller can find imports
          python3 -m pip install --upgrade pip setuptools wheel
          if [ -f "requirements.txt" ]; then python3 -m pip install -r requirements.txt; fi
          # install the project in editable mode (so PyInstaller can import package modules)
          python3 -m pip install -e "${SRC_DIR}"
          # remove previous per-project build output
          rm -rf "${SRC_DIR}/dist" "${SRC_DIR}/build" "${SRC_DIR}"/*.spec || true
          # run PyInstaller referencing the main.py path explicitly and control output locations
          python3 -m PyInstaller --onefile --name tncripo_calc "${SRC_DIR}/main.py" \
            --distpath "${SRC_DIR}/dist" --workpath "${SRC_DIR}/build" --specpath "${SRC_DIR}"
          PYR=$?
          echo "PyInstaller exit code: ${PYR}"
          echo "Listing ${SRC_DIR}/dist:"
          ls -la "${SRC_DIR}/dist" || true
        shell: bash

      - name: Prepare deb package layout for GUI app
        run: |
          set -e
          # detect project dir like above
          if [ -d "tncripo_calc" ]; then SRC_DIR=tncripo_calc; else SRC_DIR=.; fi
          PKGDIR=$(pwd)/package
          # PyInstaller writes into ${SRC_DIR}/dist by default (we set --distpath to that)
          DIST_DIR="${SRC_DIR}/dist"
          BINPATH="${DIST_DIR}/tncripo_calc"

          echo "Checking for built binary at ${BINPATH}"
          if [ ! -f "${BINPATH}" ]; then
            echo "ERROR: PyInstaller binary not found at ${BINPATH}"
            echo "Listing ${DIST_DIR}:"
            ls -la "${DIST_DIR}" || true
            echo "Listing ${SRC_DIR}:"
            ls -la "${SRC_DIR}" || true
            exit 1
          fi

          rm -rf "${PKGDIR}"
          mkdir -p "${PKGDIR}/usr/local/bin"
          mkdir -p "${PKGDIR}/usr/share/applications"
          mkdir -p "${PKGDIR}/usr/share/icons/hicolor/256x256/apps"
          mkdir -p "${PKGDIR}/usr/share/doc/tncripo-calc"

          # copy the PyInstaller-built binary using install for correct permissions
          install -m 755 "${BINPATH}" "${PKGDIR}/usr/local/bin/tncripo_calc"

          # create a .desktop file so the GUI shows in menus
          cat > "${PKGDIR}/usr/share/applications/tncripo-calc.desktop" <<EOF
          [Desktop Entry]
          Name=tncripo Calc
          Comment=Simple calculator (tncripo)
          Exec=/usr/local/bin/tncripo_calc
          Icon=utilities-calculator
          Terminal=false
          Type=Application
          Categories=Utility;Calculator;
          EOF

          # add a simple README
          echo "tncripo_calc - GUI calculator" > "${PKGDIR}/usr/share/doc/tncripo-calc/README.txt"

          # control file for the .deb
          VERSION=${{ github.run_number }}-1
          PKGNAME=tncripo-calc
          mkdir -p "${PKGDIR}/DEBIAN"
          cat > "${PKGDIR}/DEBIAN/control" <<EOF
          Package: ${PKGNAME}
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: CI <ci@example.com>
          Description: tncripo_calc - simple tkinter GUI calculator (PyInstaller binary)
          Depends: libc6 (>= 2.17)
          EOF

          chmod -R 755 "${PKGDIR}"
          sudo chown -R root:root "${PKGDIR}" || true
        shell: bash

      - name: Build .deb with dpkg-deb
        run: |
          set -e
          VERSION=${{ github.run_number }}-1
          PKGDIR=package
          OUT=tncripo_calc_${VERSION}_amd64.deb
          dpkg-deb --build "${PKGDIR}" "${OUT}"
          ls -lh "${OUT}"
          mkdir -p out
          mv "${OUT}" out/
          cp "${PKGDIR}/usr/local/bin/tncripo_calc" out/ || true
          ls -lh out || true
        shell: bash

      - name: Upload DEB and Linux binary artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tncripo_calc-linux-artifacts
          path: out/
          retention-days: 7
